<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å‘¨æ˜“å åœ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        h1 { text-align: center; color: #333; margin-top: 0; }
        .input-group { margin-bottom: 20px; }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background-color: #34495e; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        
        /* ç»“æœåŒºåŸŸï¼šç±»ä¼¼ç»ˆç«¯çš„æ˜¾ç¤ºæ•ˆæœ */
        #result-area {
            margin-top: 20px;
            padding: 20px;
            background: #1e1e1e; /* æ·±è‰²èƒŒæ™¯ */
            color: #d4d4d4;       /* æµ…ç°æ–‡å­— */
            border-radius: 8px;
            flex-grow: 1;         /* å æ»¡å‰©ä½™ç©ºé—´ */
            overflow-y: auto;     /* å¯æ»šåŠ¨ */
            font-family: 'Consolas', 'Monaco', monospace; /* ç­‰å®½å­—ä½“ */
            white-space: pre-wrap; 
            line-height: 1.5;
            font-size: 14px;
            border-left: 5px solid #2c3e50;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* è¿›åº¦æ¡åŠ¨ç”»å®¹å™¨ */
        #ai-loading {
            display: none; /* é»˜è®¤éšè— */
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        /* ç®€å•çš„æ¡çº¹è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            height: 8px;
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, transparent, #3498db, transparent);
            animation: loading-scan 1.5s infinite ease-in-out;
        }

        @keyframes loading-scan {
            0% { left: -30%; }
            100% { left: 130%; }
        }

        /* æ¨¡æ‹Ÿå…‰æ ‡é—ªçƒ */
        .cursor::after {
            content: 'â–‹';
            display: inline-block;
            vertical-align: bottom;
            animation: blink 1s infinite;
            color: #3498db;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>â˜¯ï¸ AI å‘¨æ˜“å åœ</h1>
    <div class="input-group">
        <input type="text" id="question" placeholder="å¿ƒä¸­é»˜å¿µæ‰€æ±‚ä¹‹äº‹ï¼ˆä¾‹å¦‚ï¼šæ­¤è¡Œå‡¶å‰å¦‚ä½•ï¼Ÿï¼‰...">
    </div>
    <button id="btn-divine" onclick="startDivination()">å¼€å§‹èµ·å¦</button>

    <div id="result-area" class="cursor"></div>

    <div id="ai-loading">
        ğŸ¤– AI æ­£åœ¨è§£æå¦è±¡ï¼Œè¯·ç¨å€™...
        <div class="progress-bar"></div>
    </div>
</div>

<script>
    async function startDivination() {
        const questionInput = document.getElementById('question');
        const btn = document.getElementById('btn-divine');
        const resultArea = document.getElementById('result-area');
        const aiLoading = document.getElementById('ai-loading');

        const question = questionInput.value;
        
        // 1. åˆå§‹åŒ–çŠ¶æ€
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨æ¨æ¼”...";
        resultArea.innerText = ''; // æ¸…ç©ºæ—§ç»“æœ
        aiLoading.style.display = 'none';

        try {
            // 2. å‘èµ·æµå¼è¯·æ±‚
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¾ç„¶ç”¨ POSTï¼Œä½†åç«¯ä¼šè¿”å› Stream
            const response = await fetch('http://localhost:8000/api/divine-stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            });

            if (!response.ok) throw new Error("è¿æ¥æœåŠ¡å™¨å¤±è´¥");

            // 3. å‡†å¤‡è¯»å–æµ
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                // è§£ç å½“å‰çš„äºŒè¿›åˆ¶å—
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;

                // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šæ ‡è®° (AI å¼€å§‹æ€è€ƒ)
                if (buffer.includes("<<<AI_THINKING>>>")) {
                    // æ˜¾ç¤ºåŠ è½½æ¡
                    aiLoading.style.display = 'block';
                    // ç§»é™¤æ ‡è®°ï¼Œä¸è®©å®ƒæ˜¾ç¤ºåœ¨å±å¹•ä¸Š
                    buffer = buffer.replace("<<<AI_THINKING>>>", "");
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    resultArea.scrollTop = resultArea.scrollHeight;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šæ ‡è®° (AI æ€è€ƒç»“æŸ/å¼€å§‹è¾“å‡ºç»“æœ)
                // æ³¨æ„ï¼šé€šå¸¸å¤§æ¨¡å‹è¾“å‡ºç¬¬ä¸€ä¸ªå­—æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥éšè—è¿›åº¦æ¡äº†
                // è¿™é‡Œæˆ‘ä»¬ç®€å•é€»è¾‘ï¼šå¦‚æœå·²ç»æ˜¾ç¤ºäº†è¿›åº¦æ¡ï¼Œä¸”åˆæœ‰æ–°æ–‡æœ¬(ä¸åŒ…å«æ ‡è®°)è¿›æ¥
                // ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ä¾èµ–åç«¯å‘é€å¦ä¸€ä¸ªæ ‡è®°ï¼Œæˆ–è€…ç›´æ¥è®©æ–‡å­—æ˜¾ç¤ºåœ¨è¿›åº¦æ¡ä¸‹é¢
                // æ›´å¥½çš„ä½“éªŒæ˜¯ï¼šä¸€æ—¦æ”¶åˆ° AI çš„æ–‡å­—ï¼Œéšè—è¿›åº¦æ¡
                
                // å°† buffer å†…å®¹è¿½åŠ åˆ°å±å¹•ï¼ˆè¿™é‡Œåšä¸€ä¸ªç®€å•çš„å¢é‡å¤„ç†ï¼‰
                // ä¸ºäº†é¿å…é‡å¤è¿½åŠ ï¼Œæˆ‘ä»¬åº”è¯¥åªè¿½åŠ "æ–°"çš„å†…å®¹ã€‚
                // è¿™é‡Œçš„ç®€å•åšæ³•æ˜¯ï¼šç›´æ¥æŠŠ chunk è¿½åŠ è¿›å»
                
                // ä¿®æ­£é€»è¾‘ï¼šbuffer accumulate æ˜¯ä¸ºäº†æ£€æµ‹ splitï¼Œä½†æ˜¾ç¤ºè¦å®æ—¶
                // è®©æˆ‘ä»¬ç›´æ¥å¤„ç† chunk
                
                let textToShow = chunk;
                if (textToShow.includes("<<<AI_THINKING>>>")) {
                    aiLoading.style.display = 'block';
                    textToShow = textToShow.replace("<<<AI_THINKING>>>", "");
                }
                
                // å¦‚æœè¿›åº¦æ¡æ­£åœ¨æ˜¾ç¤ºï¼Œä¸”æ”¶åˆ°äº† AI çš„ç»“æœï¼ˆé€šå¸¸æ˜¯åœ¨ THINKING ä¹‹åçš„å†…å®¹ï¼‰
                // æˆ‘ä»¬é€šè¿‡æ£€æµ‹ç‰¹å®šå…³é”®è¯ï¼ˆå¦‚â€œè§£å¦â€ï¼‰æˆ–è€…ç®€å•åœ°åœ¨ä¸€æ®µå»¶æ—¶åéšè—ï¼Œ
                // æˆ–è€…åç«¯å‘é€ <<<AI_done>>>ã€‚
                // è¿™é‡Œé‡‡ç”¨æœ€è‡ªç„¶çš„ï¼šå¦‚æœè¿›åº¦æ¡æ˜¾ç¤ºäº†ï¼Œä¸” chunk é‡Œæœ‰å®è´¨æ–‡å­—ï¼Œè¯´æ˜ AI å¼€å§‹åå­—äº†ï¼Œ
                // ä½†ç”±äºæ˜¯æµå¼ï¼Œå¯èƒ½ THINKING å’Œ ç»“æœ æ··åœ¨ä¸€èµ·ã€‚
                
                // ä¼˜åŒ–ä½“éªŒï¼šå¦‚æœåŒ…å«"AIå¤§å¸ˆè§£å¦"åçš„å†…å®¹ï¼Œé€šå¸¸æ„å‘³ç€å¼€å§‹è¾“å‡ºäº†ï¼Œ
                // æˆ‘ä»¬åœ¨CSSé‡Œä¸éœ€è¦éšè—ç»“æœåŒºï¼ŒAIç»“æœä¼šæ¥ç€æ˜¾ç¤ºã€‚
                // åªæœ‰å½“å®Œå…¨ç»“æŸæ—¶ï¼Œæˆ–è€…æ£€æµ‹åˆ° AI è¾“å‡ºæ—¶éšè— Loadingã€‚
                // æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è®© Loading ä¸€ç›´æ˜¾ç¤ºç›´åˆ°ç»“æŸï¼Œæˆ–è€…æ£€æµ‹åˆ° "æœ¬å¦:" ç­‰å…³é”®å­—ã€‚
                
                if (aiLoading.style.display === 'block' && 
                   (textToShow.includes("æœ¬å¦") || textToShow.includes("ä¹‹å¦") || textToShow.length > 5)) {
                    // AI å¼€å§‹è¾“å‡ºå®è´¨å†…å®¹äº†ï¼Œéšè—è¿›åº¦æ¡ (æˆ–è€…ä¿ç•™è¿›åº¦æ¡ç›´åˆ°æµç»“æŸ)
                    // ä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸€æ—¦AIå¼€å§‹æ‰“å­—ï¼Œå°±éšè—"ç­‰å¾…æ¡"
                    // aiLoading.style.display = 'none'; 
                    // (å¯é€‰ï¼šå¦‚æœä½ å–œæ¬¢ä¸€ç›´è½¬åœˆç›´åˆ°å®Œå…¨ç»“æŸï¼Œå°±æ³¨é‡Šæ‰ä¸Šé¢è¿™è¡Œ)
                }

                // é€å­—æ˜¾ç¤ºç‰¹æ•ˆï¼ˆå¯é€‰ï¼Œå› ä¸ºåç«¯æœ¬èº«å°±æ˜¯æ…¢é€Ÿå‘è¿‡æ¥çš„ï¼Œè¿™é‡Œç›´æ¥ append å³å¯ï¼‰
                resultArea.innerText += textToShow;
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                resultArea.scrollTop = resultArea.scrollHeight;
            }

        } catch (error) {
            console.error('Error:', error);
            resultArea.innerText += "\n\n[é”™è¯¯] è¿æ¥ä¸­æ–­æˆ–å‘ç”Ÿå¼‚å¸¸: " + error.message;
        } finally {
            // 4. æ¢å¤çŠ¶æ€
            btn.disabled = false;
            btn.innerText = "å¼€å§‹èµ·å¦";
            aiLoading.style.display = 'none'; // ç¡®ä¿æœ€åéšè—
        }
    }
</script>

</body>
</html>